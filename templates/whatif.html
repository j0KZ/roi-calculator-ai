{% extends "base.html" %}

{% block title %}What-If Analysis - ROI Calculator{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
        .slider-container {
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            margin-bottom: 0.5rem;
        }
        .slider-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        .slider-value {
            font-weight: 600;
            color: var(--bs-primary);
        }
        .impact-indicator {
            font-size: 0.85rem;
            font-weight: 500;
        }
        .impact-positive {
            color: #28a745;
        }
        .impact-negative {
            color: #dc3545;
        }
        .impact-neutral {
            color: #6c757d;
        }
        .scenario-card {
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        .scenario-card:hover {
            border-color: var(--bs-primary);
            transform: translateY(-2px);
        }
        .scenario-card.active {
            border-color: var(--bs-success);
            background-color: rgba(40, 167, 69, 0.1);
        }
        .scenario-section {
            transition: all 0.3s ease;
        }
        .scenario-section:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .baseline-comparison {
            background-color: rgba(0, 123, 255, 0.1);
            border: 1px solid rgba(0, 123, 255, 0.3);
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .sensitivity-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .sensitivity-item:last-child {
            border-bottom: none;
        }
        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 1.5rem;
        }
        .range-input {
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: #ddd;
            outline: none;
            -webkit-appearance: none;
        }
        .range-input::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--bs-primary);
            cursor: pointer;
        }
        .range-input::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--bs-primary);
            cursor: pointer;
            border: none;
        }
</style>
{% endblock %}

{% block content %}
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="hero-section text-center p-4 mb-4">
                    <h1 class="display-4">What-If Analysis</h1>
                    <p class="lead">Adjust variables and see instant changes to your ROI calculations</p>
                </div>
            </div>
        </div>

        <!-- Load Baseline Data -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-upload me-2"></i>Load Baseline Data</h5>
                    </div>
                    <div class="card-body">
                        <p class="mb-3">Start by loading example data or entering your baseline values:</p>
                        <div class="row">
                            <div class="col-md-3 mb-2">
                                <button class="btn btn-outline-primary w-100" onclick="loadBaselineExample('small_business')">
                                    <i class="fas fa-store"></i> Small Business
                                </button>
                            </div>
                            <div class="col-md-3 mb-2">
                                <button class="btn btn-outline-success w-100" onclick="loadBaselineExample('medium_business')">
                                    <i class="fas fa-building"></i> Medium Business
                                </button>
                            </div>
                            <div class="col-md-3 mb-2">
                                <button class="btn btn-outline-warning w-100" onclick="loadBaselineExample('large_business')">
                                    <i class="fas fa-industry"></i> Large Business
                                </button>
                            </div>
                            <div class="col-md-3 mb-2">
                                <button class="btn btn-outline-info w-100" onclick="showBaselineInputForm()">
                                    <i class="fas fa-keyboard"></i> Manual Entry
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Manual Input Form (Hidden by default) -->
        <div class="row mb-4" id="baselineInputForm" style="display: none;">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-edit me-2"></i>Enter Baseline Values</h5>
                    </div>
                    <div class="card-body">
                        <form id="baselineForm">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="baseline_annual_revenue" class="form-label">Annual Revenue ($)</label>
                                    <input type="number" class="form-control" id="baseline_annual_revenue" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="baseline_monthly_orders" class="form-label">Monthly Orders</label>
                                    <input type="number" class="form-control" id="baseline_monthly_orders" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="baseline_avg_order_value" class="form-label">Average Order Value ($)</label>
                                    <input type="number" step="0.01" class="form-control" id="baseline_avg_order_value" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="baseline_labor_costs" class="form-label">Labor Costs ($/month)</label>
                                    <input type="number" step="0.01" class="form-control" id="baseline_labor_costs" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="baseline_shipping_costs" class="form-label">Shipping Costs ($/month)</label>
                                    <input type="number" step="0.01" class="form-control" id="baseline_shipping_costs" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="baseline_error_costs" class="form-label">Error Costs ($/month)</label>
                                    <input type="number" step="0.01" class="form-control" id="baseline_error_costs" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="baseline_inventory_costs" class="form-label">Inventory Costs ($/month)</label>
                                    <input type="number" step="0.01" class="form-control" id="baseline_inventory_costs" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="baseline_service_investment" class="form-label">Service Investment ($)</label>
                                    <input type="number" step="0.01" class="form-control" id="baseline_service_investment" required>
                                </div>
                            </div>
                            <button type="button" class="btn btn-success" onclick="setBaseline()">Set Baseline</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main What-If Interface -->
        <div id="whatifInterface" style="display: none;">
            <!-- Three Scenario Analysis Row -->
            <div class="row mb-3">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header py-2 bg-primary text-white">
                            <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Scenario Analysis</h5>
                        </div>
                        <div class="card-body p-3">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="scenario-section border rounded p-3 h-100" style="border-color: #dc3545 !important; background-color: rgba(220, 53, 69, 0.05);">
                                        <h6 class="text-danger mb-3"><i class="fas fa-exclamation-triangle me-2"></i>Worst Case</h6>
                                        <div id="worstCaseResults" class="mb-3">
                                            <div class="small text-muted">ROI: <span id="worst-roi" class="text-danger fw-bold">--</span></div>
                                            <div class="small text-muted">Payback: <span id="worst-payback" class="text-danger fw-bold">--</span></div>
                                            <div class="small text-muted">Annual Savings: <span id="worst-savings" class="text-danger fw-bold">--</span></div>
                                        </div>
                                        <button class="btn btn-outline-danger btn-sm w-100" onclick="applyScenario('worst')">
                                            <i class="fas fa-arrow-down me-1"></i>Apply Worst Case
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="scenario-section border rounded p-3 h-100" style="border-color: #ffc107 !important; background-color: rgba(255, 193, 7, 0.05);">
                                        <h6 class="text-warning mb-3"><i class="fas fa-balance-scale me-2"></i>Most Likely</h6>
                                        <div id="mostLikelyResults" class="mb-3">
                                            <div class="small text-muted">ROI: <span id="likely-roi" class="text-warning fw-bold">--</span></div>
                                            <div class="small text-muted">Payback: <span id="likely-payback" class="text-warning fw-bold">--</span></div>
                                            <div class="small text-muted">Annual Savings: <span id="likely-savings" class="text-warning fw-bold">--</span></div>
                                        </div>
                                        <button class="btn btn-outline-warning btn-sm w-100" onclick="applyScenario('likely')">
                                            <i class="fas fa-equals me-1"></i>Apply Most Likely
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="scenario-section border rounded p-3 h-100" style="border-color: #28a745 !important; background-color: rgba(40, 167, 69, 0.05);">
                                        <h6 class="text-success mb-3"><i class="fas fa-rocket me-2"></i>Best Case</h6>
                                        <div id="bestCaseResults" class="mb-3">
                                            <div class="small text-muted">ROI: <span id="best-roi" class="text-success fw-bold">--</span></div>
                                            <div class="small text-muted">Payback: <span id="best-payback" class="text-success fw-bold">--</span></div>
                                            <div class="small text-muted">Annual Savings: <span id="best-savings" class="text-success fw-bold">--</span></div>
                                        </div>
                                        <button class="btn btn-outline-success btn-sm w-100" onclick="applyScenario('best')">
                                            <i class="fas fa-arrow-up me-1"></i>Apply Best Case
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-12">
                                    <div class="alert alert-info mb-0">
                                        <i class="fas fa-info-circle me-2"></i>
                                        <strong>Quick Scenarios:</strong> Click any button above to instantly apply predefined scenarios, or use the sliders below for custom adjustments.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Variable Controls Row -->
            <div class="row mb-3">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header py-2 d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="fas fa-sliders-h me-2"></i>Adjust Variables</h5>
                            <div>
                                <button class="btn btn-outline-secondary btn-sm me-2" onclick="resetToBaseline()">
                                    <i class="fas fa-undo me-1"></i>Reset to Baseline
                                </button>
                                <button class="btn btn-primary btn-sm" onclick="saveScenario()">
                                    <i class="fas fa-save me-1"></i>Save Scenario
                                </button>
                            </div>
                        </div>
                        <div class="card-body p-3">
                            <div id="variableControls" class="row">
                                <!-- Variable sliders will be generated here in grid layout -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Results Panel Row -->
            <div class="row">
                <div class="col-12">
                <!-- Baseline Comparison -->
                <div class="baseline-comparison" id="baselineComparison">
                    <h6><i class="fas fa-balance-scale me-2"></i>Baseline vs. Current</h6>
                    <div id="comparisonMetrics">
                        <!-- Comparison metrics will be shown here -->
                    </div>
                </div>

                <!-- ROI Impact Chart -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-line me-2"></i>ROI Impact Visualization</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="impactChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Sensitivity Analysis -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5><i class="fas fa-thermometer-half me-2"></i>Sensitivity Analysis</h5>
                    </div>
                    <div class="card-body">
                        <div id="sensitivityAnalysis">
                            <!-- Sensitivity percentages will be shown here -->
                        </div>
                    </div>
                </div>

                <!-- Detailed Results -->
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-bar me-2"></i>Current Results</h5>
                    </div>
                    <div class="card-body" id="currentResults">
                        <!-- Current calculation results will be shown here -->
                    </div>
                </div>
            </div>
        </div>
<!-- Save Scenario Modal -->
<div class="modal fade" id="saveScenarioModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-save me-2"></i>Save What-If Scenario</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="scenarioName" class="form-label">Scenario Name</label>
                    <input type="text" class="form-control" id="scenarioName" placeholder="e.g., Optimistic Q2 2024">
                </div>
                <div class="mb-3">
                    <label for="scenarioNotes" class="form-label">Notes (optional)</label>
                    <textarea class="form-control" id="scenarioNotes" rows="3" placeholder="Describe the scenario and assumptions..."></textarea>
                </div>
                <div class="mb-3">
                    <label for="scenarioTags" class="form-label">Tags (optional, comma-separated)</label>
                    <input type="text" class="form-control" id="scenarioTags" placeholder="e.g., what-if, q2-2024, optimistic">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="confirmSaveScenario()">
                    <i class="fas fa-save me-2"></i>Save Scenario
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3">Processing...</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/whatif.js') }}"></script>
{% endblock %}