{% extends "base.html" %}

{% block title %}Calculation History - E-commerce ROI Calculator{% endblock %}

{% block extra_head %}
<style>
        .calculation-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }
        
        .calculation-card:hover {
            transform: translateY(-2px);
            background: rgba(255, 255, 255, 0.08);
            border-color: var(--accent);
        }
        
        .roi-badge {
            background: var(--accent);
            color: var(--primary);
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 1.2rem;
        }
        
        .search-container {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
        }
        
        .btn-view {
            background: transparent;
            border: 1px solid var(--accent);
            color: var(--accent);
        }
        
        .btn-view:hover {
            background: var(--accent);
            color: var(--primary);
        }
        
        .empty-state {
            text-align: center;
            padding: 60px;
            color: var(--text-secondary);
        }
        
        .empty-state i {
            font-size: 4rem;
            color: var(--accent);
            margin-bottom: 20px;
        }
</style>
{% endblock %}

{% block content %}
        <!-- Header Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="hero-section text-center p-4 mb-4">
                    <h1 class="display-4">Calculation History</h1>
                    <p class="lead">View and manage your saved ROI calculations</p>
                </div>
            </div>
        </div>

        <!-- Search and Filter Section -->
        <div class="search-container">
            <div class="row">
                <div class="col-md-4">
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                        <input type="text" class="form-control" id="searchInput" placeholder="Search by company name...">
                    </div>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-success w-100" onclick="searchCalculations()">
                        <i class="fas fa-search"></i> Search
                    </button>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-secondary w-100" onclick="resetSearch()">
                        <i class="fas fa-redo"></i> Reset
                    </button>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-warning w-100" onclick="toggleCompareMode()" id="compareModeBtn">
                        <i class="fas fa-balance-scale"></i> Compare Mode
                    </button>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-info w-100" onclick="compareSelected()" id="compareBtn" style="display: none;" disabled>
                        <i class="fas fa-balance-scale"></i> Compare (<span id="compareCount">0</span>)
                    </button>
                </div>
            </div>
        </div>

        <!-- Calculations List -->
        <div id="calculationsList">
            <div class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3">Loading calculations...</p>
            </div>
        </div>

        <!-- Pagination -->
        <nav aria-label="Page navigation" id="paginationContainer" style="display: none;">
            <ul class="pagination justify-content-center" id="pagination">
            </ul>
        </nav>
<!-- View Modal -->
    <div class="modal fade" id="viewModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Calculation Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="modalContent">
                    <!-- Content will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-danger" id="regeneratePdfBtn">
                        <i class="fas fa-file-pdf"></i> Regenerate PDF
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentPage = 0;
        let itemsPerPage = 10;
        let totalItems = 0;
        let currentCalcId = null;
        let compareMode = false;
        let selectedForComparison = [];

        // Load calculations on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadCalculations();
        });

        async function loadCalculations(page = 0) {
            const search = document.getElementById('searchInput').value;
            const offset = page * itemsPerPage;
            
            try {
                const response = await fetch(`/api/calculations?limit=${itemsPerPage}&offset=${offset}&search=${search}`);
                const result = await response.json();
                
                if (result.success) {
                    totalItems = result.total;
                    displayCalculations(result.calculations);
                    updatePagination(page);
                }
            } catch (error) {
                console.error('Error loading calculations:', error);
                document.getElementById('calculationsList').innerHTML = `
                    <div class="alert alert-danger">
                        Error loading calculations. Please try again later.
                    </div>
                `;
            }
        }

        function displayCalculations(calculations) {
            const container = document.getElementById('calculationsList');
            
            if (calculations.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <h3>No Calculations Found</h3>
                        <p>You haven't saved any calculations yet.</p>
                        <a href="/" class="btn btn-primary mt-3">
                            <i class="fas fa-plus"></i> Create New Calculation
                        </a>
                    </div>
                `;
                return;
            }
            
            let html = '';
            calculations.forEach(calc => {
                const date = new Date(calc.created_at).toLocaleDateString();
                // Extract ROI and payback from nested structure
                const roi = calc.results?.roi_metrics?.first_year_roi || calc.results?.roi_percentage || 0;
                const payback = calc.results?.roi_metrics?.payback_period_months || calc.results?.payback_months || 0;
                
                const isSelected = selectedForComparison.includes(calc.id);
                
                html += `
                    <div class="calculation-card ${compareMode && isSelected ? 'selected' : ''}" ${compareMode ? `onclick="toggleComparisonSelection(${calc.id})"` : ''}>
                        <div class="row align-items-center">
                            ${compareMode ? `
                            <div class="col-md-1">
                                <input type="checkbox" class="form-check-input" ${isSelected ? 'checked' : ''} onchange="event.stopPropagation();">
                            </div>
                            ` : ''}
                            <div class="col-md-${compareMode ? '5' : '6'}">
                                <h5>${calc.company_name || 'Unnamed Company'}</h5>
                                <p class="text-muted mb-1">
                                    <i class="fas fa-calendar"></i> ${date}
                                </p>
                                <p class="text-muted">
                                    <i class="fas fa-dollar-sign"></i> Revenue: $${formatNumber(calc.annual_revenue)}
                                </p>
                            </div>
                            <div class="col-md-3 text-center">
                                <div class="roi-badge">${roi.toFixed(1)}% ROI</div>
                                <small class="text-muted d-block mt-2">${payback.toFixed(1)} months payback</small>
                            </div>
                            <div class="col-md-3 text-end">
                                ${!compareMode ? `
                                <button class="btn btn-view btn-sm" onclick="viewCalculation(${calc.id})">
                                    <i class="fas fa-eye"></i> View
                                </button>
                                <button class="btn btn-danger btn-sm ms-2" onclick="deleteCalculation(${calc.id})">
                                    <i class="fas fa-trash"></i>
                                </button>
                                ` : `
                                <div class="form-text">
                                    ${isSelected ? '<i class="fas fa-check-circle text-success"></i> Selected' : 'Click to select'}
                                </div>
                                `}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function updatePagination(currentPage) {
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            const paginationContainer = document.getElementById('paginationContainer');
            const pagination = document.getElementById('pagination');
            
            if (totalPages <= 1) {
                paginationContainer.style.display = 'none';
                return;
            }
            
            paginationContainer.style.display = 'block';
            let html = '';
            
            // Previous button
            html += `
                <li class="page-item ${currentPage === 0 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${currentPage - 1})">Previous</a>
                </li>
            `;
            
            // Page numbers
            for (let i = 0; i < totalPages; i++) {
                html += `
                    <li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="changePage(${i})">${i + 1}</a>
                    </li>
                `;
            }
            
            // Next button
            html += `
                <li class="page-item ${currentPage === totalPages - 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${currentPage + 1})">Next</a>
                </li>
            `;
            
            pagination.innerHTML = html;
        }

        function changePage(page) {
            if (page >= 0 && page < Math.ceil(totalItems / itemsPerPage)) {
                currentPage = page;
                loadCalculations(page);
            }
        }

        function searchCalculations() {
            currentPage = 0;
            loadCalculations(0);
        }

        function resetSearch() {
            document.getElementById('searchInput').value = '';
            searchCalculations();
        }

        async function viewCalculation(id) {
            currentCalcId = id;
            try {
                const response = await fetch(`/api/calculation/${id}`);
                const result = await response.json();
                
                if (result.success) {
                    displayCalculationModal(result.calculation);
                    new bootstrap.Modal(document.getElementById('viewModal')).show();
                }
            } catch (error) {
                console.error('Error loading calculation:', error);
            }
        }

        function displayCalculationModal(calc) {
            // Extract ROI and payback from nested structure
            const roi = calc.results?.roi_metrics?.first_year_roi || calc.results?.roi_percentage || 0;
            const payback = calc.results?.roi_metrics?.payback_period_months || calc.results?.payback_months || 0;
            const savings = calc.results?.savings || {};
            
            document.getElementById('modalContent').innerHTML = `
                <h4>${calc.company_name || 'Unnamed Company'}</h4>
                <hr>
                <div class="row">
                    <div class="col-md-6">
                        <h6>Business Information</h6>
                        <ul class="list-unstyled">
                            <li><strong>Annual Revenue:</strong> $${formatNumber(calc.annual_revenue)}</li>
                            <li><strong>Monthly Orders:</strong> ${formatNumber(calc.monthly_orders)}</li>
                            <li><strong>Avg Order Value:</strong> $${calc.avg_order_value.toFixed(2)}</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>Current Costs</h6>
                        <ul class="list-unstyled">
                            <li><strong>Labor:</strong> $${formatNumber(calc.labor_costs)}/mo</li>
                            <li><strong>Shipping:</strong> $${formatNumber(calc.shipping_costs)}/mo</li>
                            <li><strong>Errors:</strong> $${formatNumber(calc.error_costs)}/mo</li>
                            <li><strong>Inventory:</strong> $${formatNumber(calc.inventory_costs)}/mo</li>
                        </ul>
                    </div>
                </div>
                <hr>
                <div class="row">
                    <div class="col-md-6">
                        <div class="alert alert-success">
                            <h5>ROI: ${roi.toFixed(1)}%</h5>
                            <p>Payback Period: ${payback.toFixed(1)} months</p>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="alert alert-info">
                            <h5>Investment: $${formatNumber(calc.service_investment)}</h5>
                            <p>Total Savings: $${formatNumber(savings.total_monthly || 0)}/mo</p>
                        </div>
                    </div>
                </div>
                ${calc.notes ? `<div class="alert alert-secondary"><strong>Notes:</strong> ${calc.notes}</div>` : ''}
            `;
            
            // Setup regenerate PDF button
            document.getElementById('regeneratePdfBtn').onclick = () => regeneratePDF(calc);
        }

        async function deleteCalculation(id) {
            if (!confirm('Are you sure you want to delete this calculation?')) return;
            
            try {
                const response = await fetch(`/api/calculation/${id}`, {
                    method: 'DELETE'
                });
                const result = await response.json();
                
                if (result.success) {
                    loadCalculations(currentPage);
                    showToast('Calculation deleted successfully', 'success');
                }
            } catch (error) {
                console.error('Error deleting calculation:', error);
                showToast('Error deleting calculation', 'danger');
            }
        }

        async function regeneratePDF(calc) {
            // Prepare data for PDF generation - need to include results
            const dataWithResults = {
                results: calc.results // Include the results for PDF generation
            };
            
            try {
                const response = await fetch('/generate-pdf', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(dataWithResults)
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = `ROI_Report_${calc.company_name || 'Company'}.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    showToast('PDF regenerated successfully', 'success');
                }
            } catch (error) {
                console.error('Error regenerating PDF:', error);
                showToast('Error regenerating PDF', 'danger');
            }
        }

        function formatNumber(num) {
            if (typeof num !== 'number') return '0';
            return num.toLocaleString('en-US', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            });
        }

        function showToast(message, type) {
            const toast = document.createElement('div');
            toast.className = `alert alert-${type} position-fixed top-0 end-0 m-3`;
            toast.style.zIndex = '9999';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function toggleCompareMode() {
            compareMode = !compareMode;
            selectedForComparison = [];
            
            const compareModeBtn = document.getElementById('compareModeBtn');
            const compareBtn = document.getElementById('compareBtn');
            
            if (compareMode) {
                compareModeBtn.innerHTML = '<i class="fas fa-times"></i> Exit Compare';
                compareModeBtn.classList.remove('btn-warning');
                compareModeBtn.classList.add('btn-danger');
                compareBtn.style.display = 'block';
                showToast('Select 2-3 calculations to compare', 'info');
            } else {
                compareModeBtn.innerHTML = '<i class="fas fa-balance-scale"></i> Compare Mode';
                compareModeBtn.classList.remove('btn-danger');
                compareModeBtn.classList.add('btn-warning');
                compareBtn.style.display = 'none';
            }
            
            updateCompareCounter();
            loadCalculations(currentPage); // Refresh to show/hide checkboxes
        }

        function toggleComparisonSelection(calcId) {
            if (!compareMode) return;
            
            const index = selectedForComparison.indexOf(calcId);
            if (index > -1) {
                selectedForComparison.splice(index, 1);
            } else {
                if (selectedForComparison.length >= 3) {
                    showToast('You can select maximum 3 calculations for comparison', 'warning');
                    return;
                }
                selectedForComparison.push(calcId);
            }
            
            updateCompareCounter();
            loadCalculations(currentPage); // Refresh to update selection styling
        }

        function updateCompareCounter() {
            const counter = document.getElementById('compareCount');
            const compareBtn = document.getElementById('compareBtn');
            
            counter.textContent = selectedForComparison.length;
            compareBtn.disabled = selectedForComparison.length < 2;
            
            if (selectedForComparison.length >= 2) {
                compareBtn.classList.remove('btn-secondary');
                compareBtn.classList.add('btn-info');
            } else {
                compareBtn.classList.remove('btn-info');
                compareBtn.classList.add('btn-secondary');
            }
        }

        function compareSelected() {
            if (selectedForComparison.length < 2) {
                showToast('Please select at least 2 calculations to compare', 'warning');
                return;
            }
            
            // Redirect to compare page with selected calculation IDs
            const params = new URLSearchParams();
            params.set('ids', selectedForComparison.join(','));
            window.location.href = `/compare?${params.toString()}`;
        }
    </script>
{% endblock %}

{% block scripts %}{% endblock %}